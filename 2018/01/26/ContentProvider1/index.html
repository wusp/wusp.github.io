<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            ContentProvider系列1-获取ContentProvider | 
        
        wusp Blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="wusp Blog">
    <meta name="msapplication-starturl" content="http://yoursite.com/2018/01/26/ContentProvider1/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="wusp Blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com/2018/01/26/ContentProvider1/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="ContentProvider系列1-获取ContentProvider | wusp Blog">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    

    
        <meta property="article:published_time" content="Fri Jan 26 2018 19:10:10 GMT+0800">
        <meta property="article:modified_time" content="Sat Mar 03 2018 16:27:52 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/01/26/ContentProvider1/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2018/01/26/ContentProvider1/index.html",
    "headline": "ContentProvider系列1-获取ContentProvider",
    "datePublished": "Fri Jan 26 2018 19:10:10 GMT+0800",
    "dateModified": "Sat Mar 03 2018 16:27:52 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "wusp",
        "image": {
            "@type": "ImageObject",
            "url": "/img/wusp.jpg"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "wusp Blog",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": "",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#本篇基于Android-Framework-8-0的源码"><span class="post-toc-number">1.</span> <span class="post-toc-text">本篇基于Android Framework 8.0的源码</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Basics"><span class="post-toc-number"></span> <span class="post-toc-text">Basics</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#1-ContentProviderRecord"><span class="post-toc-number"></span> <span class="post-toc-text">1. ContentProviderRecord</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#2-ProviderClientRecord"><span class="post-toc-number"></span> <span class="post-toc-text">2. ProviderClientRecord</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Acquire-ContentProvider-on-App"><span class="post-toc-number"></span> <span class="post-toc-text">Acquire ContentProvider on App</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#第一部分：获取缓存中的IContentProvider的逻辑："><span class="post-toc-number">1.</span> <span class="post-toc-text">第一部分：获取缓存中的IContentProvider的逻辑：</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#第二部分：通过AMS-getContentProvider-获取IContentProvider接口"><span class="post-toc-number">2.</span> <span class="post-toc-text">第二部分：通过AMS.getContentProvider()获取IContentProvider接口</span></a></li><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#第三部分：执行ActivityThread-installProvider"><span class="post-toc-number">3.</span> <span class="post-toc-text">第三部分：执行ActivityThread.installProvider()</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                ContentProvider系列1-获取ContentProvider
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/wusp.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>wusp</strong>
        <span>1月 26, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=ContentProvider系列1-获取ContentProvider&url=http://yoursite.com/2018/01/26/ContentProvider1/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=ContentProvider系列1-获取ContentProvider&url=http://yoursite.com/2018/01/26/ContentProvider1/index.html&via=wusp" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/01/26/ContentProvider1/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/01/26/ContentProvider1/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h6 id="本篇基于Android-Framework-8-0的源码"><a href="#本篇基于Android-Framework-8-0的源码" class="headerlink" title="本篇基于Android Framework 8.0的源码"></a>本篇基于Android Framework 8.0的源码</h6><p>对ContentProvider的使用从根本上来说也是围绕着Binder IPC。跟使用其他系统服务类似，APP对ContentProvider的使用可以分成三部分：</p>
<ul>
<li><strong>Client APP如何从系统服务中获取到ContentProvider的调用接口</strong></li>
<li>ContentProvider如何将自己的调用接口发布到系统服务当中。</li>
<li>Client APP调用ContentProvider接口的具体流程。</li>
</ul>
<p>本文的核心便是<strong>Client APP如何从系统服务中获取到ContentProvider的调用接口</strong>。</p>
<h3 id="Basics"><a href="#Basics" class="headerlink" title="Basics"></a>Basics</h3><p>记录ContentProvider相关信息的数据对象</p>
<h5 id="1-ContentProviderRecord"><a href="#1-ContentProviderRecord" class="headerlink" title="1. ContentProviderRecord"></a>1. ContentProviderRecord</h5><p>在记录ContentProvider重要信息的数据对象中，毫无疑问ContentProviderRecord是最重要的。无论是在ProcessRecord中记录本APP内已经发布的ContentProvider，还是在AMS中记录所有APP发布的ContentProvider。<br>ContentProviderRecord中记录的重要内容：<br><img src="/2018/01/26/ContentProvider1/ContentProviderRecord.jpg" title="ContentProviderRecord"></p>
<h5 id="2-ProviderClientRecord"><a href="#2-ProviderClientRecord" class="headerlink" title="2. ProviderClientRecord"></a>2. ProviderClientRecord</h5><p>另外一个重要的则是ProviderClientRecord，用于在Client APP中缓存已经获得的ContentProvider信息（包括本地的ContentProvider）。在使用ContentProvider时，如果发现缓存中已经存在对应的ContentProvider信息，则<br>不再向AMS请求获取ContentProvider接口，而是直接使用缓存中记录的IContentProvider接口。<br><img src="/2018/01/26/ContentProvider1/ProviderClientRecord.jpg" title="ProviderClientRecord"><br>ProviderClientRecord中记录的IContentProvider是由ContentProviderHolder传来，在AMS初始化ContentProviderHolder时会将其中的IContentProvider赋值为IContentProvider的代理对象——<strong>ContentProviderProxy</strong>。后续通过ContentResolver执行ContentProvider的CRUD操作时，便是通过ContentProviderProxy对象Binder IPC到实际的ContentProvider中。</p>
<h3 id="Acquire-ContentProvider-on-App"><a href="#Acquire-ContentProvider-on-App" class="headerlink" title="Acquire ContentProvider on App"></a>Acquire ContentProvider on App</h3><p>在Client APP使用过程中，一般不会直接与ContentProvider进行通信，使用ContentProvider的请求都是交由ContentResolver来执行。平时获取ContentResolver都是通过Context的getContentResolver()来执行，最终都会执行的是<strong>ContextImpl</strong>中的getContentResolver():</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ContextImpl.java</span><br><span class="line">public ContentResolver getContentResolver() &#123;</span><br><span class="line">        return mContentResolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的是已经保存在Context中的mContentResolver，这一实例的初始化在ContextImpl的相关初始化函数当中：<strong>( 8.0在私有构造器中，4.2在init函数当中 )</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//ContextImpl.java</span><br><span class="line">...</span><br><span class="line">mContentResolver = new ApplicationContentResolver(this, mainThread, user);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里赋值的实例<strong>ApplicationContentResolver</strong>类型，这是一个ContentResolver接口的实现类，里边重写了<strong>获取和释放ContentProvider的逻辑</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected IContentProvider acquireProvider(Context context, String auth) &#123;</span><br><span class="line">    return mMainThread.acquireProvider(context,</span><br><span class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">            resolveUserIdFromAuthority(auth), true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected IContentProvider acquireExistingProvider(Context context, String auth) &#123;</span><br><span class="line">    return mMainThread.acquireExistingProvider(context,</span><br><span class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">            resolveUserIdFromAuthority(auth), true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public boolean releaseProvider(IContentProvider provider) &#123;</span><br><span class="line">    return mMainThread.releaseProvider(provider, true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected IContentProvider acquireUnstableProvider(Context c, String auth) &#123;</span><br><span class="line">    return mMainThread.acquireProvider(c,</span><br><span class="line">            ContentProvider.getAuthorityWithoutUserId(auth),</span><br><span class="line">            resolveUserIdFromAuthority(auth), false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public boolean releaseUnstableProvider(IContentProvider icp) &#123;</span><br><span class="line">    return mMainThread.releaseProvider(icp, false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void unstableProviderDied(IContentProvider icp) &#123;</span><br><span class="line">    mMainThread.handleUnstableProviderDied(icp.asBinder(), true);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void appNotRespondingViaProvider(IContentProvider icp) &#123;</span><br><span class="line">    mMainThread.appNotRespondingViaProvider(icp.asBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过这里实现的内容只是相当于转发了一下请求到ActivityThread当中去执行具体的逻辑，由ActivityThread来负责同AMS进行交互。</p>
<p><strong>acquireExistingProvider（）</strong>、<strong>acquireProvider（）</strong>和<strong>acquireUnstableProvider（）</strong>最终执行的都是同一个方法<strong><em>acquireProvider()</em></strong>，区别在于最后一个标识符，true代表stable provider，false代表unstable provider.<br>在<strong>ActivityThread</strong>中的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">final IContentProvider provider = acquireExistingProvider(c, auth, userId, stable);</span><br><span class="line">        if (provider != null) &#123;</span><br><span class="line">            return provider;</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager.ContentProviderHolder holder = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            holder = ActivityManagerNative.getDefault().getContentProvider(</span><br><span class="line">                    getApplicationThread(), auth, userId, stable);</span><br><span class="line">        &#125; catch (RemoteException ex) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        if (holder == null) &#123;</span><br><span class="line">            Slog.e(TAG, &quot;Failed to find provider info for &quot; + auth);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        holder = installProvider(c, holder, holder.info,</span><br><span class="line">                true /*noisy*/, holder.noReleaseNeeded, stable);</span><br><span class="line">        return holder.provider;</span><br></pre></td></tr></table></figure>
<p><strong>acquireProvider()</strong>分为三部分：</p>
<ul>
<li>1.首先尝试获取缓存的IContentProvider。</li>
<li>2.获取不到才通过AMS获取IContentProvider。</li>
<li>3.获取成功后先执行ActivityThread.installProvider再返回provider给ContentResolver。</li>
</ul>
<h6 id="第一部分：获取缓存中的IContentProvider的逻辑："><a href="#第一部分：获取缓存中的IContentProvider的逻辑：" class="headerlink" title="第一部分：获取缓存中的IContentProvider的逻辑："></a>第一部分：获取缓存中的IContentProvider的逻辑：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">synchronized (mProviderMap) &#123;</span><br><span class="line">    final ProviderKey key = new ProviderKey(auth, userId);</span><br><span class="line">    final ProviderClientRecord pr = mProviderMap.get(key);</span><br><span class="line">    if (pr == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IContentProvider provider = pr.mProvider;</span><br><span class="line">    IBinder jBinder = provider.asBinder();</span><br><span class="line">    if (!jBinder.isBinderAlive()) &#123;</span><br><span class="line">        Log.i(TAG, &quot;Acquiring provider &quot; + auth + &quot; for user &quot; + userId</span><br><span class="line">                + &quot;: existing object&apos;s process dead&quot;);</span><br><span class="line">        handleUnstableProviderDiedLocked(jBinder, true);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    ProviderRefCount prc = mProviderRefCountMap.get(jBinder);</span><br><span class="line">    if (prc != null) &#123;</span><br><span class="line">        incProviderRefLocked(prc, stable);</span><br><span class="line">    &#125;</span><br><span class="line">    return provider;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>由于接口可能会被多线程调用，因此这里先加了锁。</li>
<li>首先通过auth、userId从mProviderMap中获取provider。</li>
<li>如果该provider所在的进程已经死亡则调用handleUnstableProviderDiedLocked，并返回null。</li>
<li>在handleUnstableProviderDiedLocked()里，如果死亡的provider保存在<strong>需要释放的Provider列表里</strong>，则对其进行释放清理；并通知AMS该unstable provider已经死亡。</li>
<li>如果保存在<strong>需要释放的Provider列表里</strong>，则对其引用计数+1。</li>
</ul>
<h6 id="第二部分：通过AMS-getContentProvider-获取IContentProvider接口"><a href="#第二部分：通过AMS-getContentProvider-获取IContentProvider接口" class="headerlink" title="第二部分：通过AMS.getContentProvider()获取IContentProvider接口"></a>第二部分：通过AMS.getContentProvider()获取IContentProvider接口</h6><p>最后都在getContentProviderImpl()中执行：<br>这里是Blocking执行，lock是AMS。这把锁很多地方都用到，比方注册广播接收器时也是用的这把锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">long startTime = SystemClock.uptimeMillis();</span><br><span class="line">//获取Caller的进程信息</span><br><span class="line">ProcessRecord r = null;</span><br><span class="line">if (caller != null) &#123;</span><br><span class="line">    r = getRecordForAppLocked(caller);</span><br><span class="line">    if (r == null) &#123;</span><br><span class="line">        throw new SecurityException(</span><br><span class="line">                &quot;Unable to find app for caller &quot; + caller</span><br><span class="line">              + &quot; (pid=&quot; + Binder.getCallingPid()</span><br><span class="line">              + &quot;) when getting content provider &quot; + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">boolean checkCrossUser = true;</span><br><span class="line">checkTime(startTime, &quot;getContentProviderImpl: getProviderByName&quot;);</span><br><span class="line">//检查对应的ContentProvider是否已经存在</span><br><span class="line">cpr = mProviderMap.getProviderByName(name, userId);</span><br><span class="line">if (cpr == null &amp;&amp; userId != UserHandle.USER_SYSTEM) &#123;</span><br><span class="line">    cpr = mProviderMap.getProviderByName(name, UserHandle.USER_SYSTEM);</span><br><span class="line">    if (cpr != null) &#123;</span><br><span class="line">        cpi = cpr.info;</span><br><span class="line">        if (isSingleton(cpi.processName, cpi.applicationInfo,</span><br><span class="line">                cpi.name, cpi.flags)</span><br><span class="line">                &amp;&amp; isValidSingletonCall(r.uid, cpi.applicationInfo.uid)) &#123;</span><br><span class="line">            userId = UserHandle.USER_SYSTEM;</span><br><span class="line">            checkCrossUser = false;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //不是单例则清空继续执行获取</span><br><span class="line">            cpr = null;</span><br><span class="line">            cpi = null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ContentProvider存在同时所在进程存在&amp;该进程没被杀</span><br><span class="line">boolean providerRunning = cpr != null &amp;&amp; cpr.proc != null &amp;&amp; !cpr.proc.killed;</span><br><span class="line">// 后续的内容分段讲解</span><br><span class="line">...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>AMS会先尝试获取缓存的ContentProvider信息，并判断该ContentProvider是否保持运行，并以此为根据来进行后续的执行。后续方法体的执行分为三部分：</p>
<p><strong>1.ContentProvider保持运行</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">if (providerRunning) &#123;</span><br><span class="line">                cpi = cpr.info;</span><br><span class="line">                String msg;</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: before checkContentProviderPermission&quot;);</span><br><span class="line">                if ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                        != null) &#123;</span><br><span class="line">                    throw new SecurityException(msg);</span><br><span class="line">                &#125;</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: after checkContentProviderPermission&quot;);</span><br><span class="line"></span><br><span class="line">                //如果provider已经发布或者正在发布则直接返回。</span><br><span class="line">                if (r != null &amp;&amp; cpr.canRunHere(r)) &#123;</span><br><span class="line">                    ContentProviderHolder holder = cpr.newHolder(null);</span><br><span class="line">                    holder.provider = null;</span><br><span class="line">                    return holder;</span><br><span class="line">                &#125;</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (AppGlobals.getPackageManager()</span><br><span class="line">                            .resolveContentProvider(name, 0 /*flags*/, userId) == null) &#123;</span><br><span class="line">                        return null;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (RemoteException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                final long origId = Binder.clearCallingIdentity();</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: incProviderCountLocked&quot;);</span><br><span class="line"></span><br><span class="line">                // 增加引用计数</span><br><span class="line">                conn = incProviderCountLocked(r, cpr, token, stable);</span><br><span class="line">                if (conn != null &amp;&amp; (conn.stableCount+conn.unstableCount) == 1) &#123;</span><br><span class="line">                    if (cpr.proc != null &amp;&amp; r.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                        //更新LRU</span><br><span class="line">                        checkTime(startTime, &quot;getContentProviderImpl: before updateLruProcess&quot;);</span><br><span class="line">                        updateLruProcessLocked(cpr.proc, false, null);</span><br><span class="line">                        checkTime(startTime, &quot;getContentProviderImpl: after updateLruProcess&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: before updateOomAdj&quot;);</span><br><span class="line">                final int verifiedAdj = cpr.proc.verifiedAdj;</span><br><span class="line">                //更新进程adj</span><br><span class="line">                boolean success = updateOomAdjLocked(cpr.proc, true);</span><br><span class="line">                if (success &amp;&amp; verifiedAdj != cpr.proc.setAdj &amp;&amp; !isProcessAliveLocked(cpr.proc)) &#123;</span><br><span class="line">                    success = false;</span><br><span class="line">                &#125;</span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, cpr.info.packageName, name);</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: after updateOomAdj&quot;);</span><br><span class="line">                if (DEBUG_PROVIDER) Slog.i(TAG_PROVIDER, &quot;Adjust success: &quot; + success);</span><br><span class="line">                //进程已经被杀</span><br><span class="line">                if (!success) &#123;</span><br><span class="line">                    //确保自己不为同时杀掉</span><br><span class="line">                    Slog.i(TAG, &quot;Existing provider &quot; + cpr.name.flattenToShortString()</span><br><span class="line">                            + &quot; is crashing; detaching &quot; + r);</span><br><span class="line">                    //减少引用计数</span><br><span class="line">                    boolean lastRef = decProviderCountLocked(conn, cpr, token, stable);</span><br><span class="line">                    checkTime(startTime, &quot;getContentProviderImpl: before appDied&quot;);</span><br><span class="line">                    appDiedLocked(cpr.proc);</span><br><span class="line">                    checkTime(startTime, &quot;getContentProviderImpl: after appDied&quot;);</span><br><span class="line">                    if (!lastRef) &#123;</span><br><span class="line">                        // This wasn&apos;t the last ref our process had on</span><br><span class="line">                        // the provider...  we have now been killed, bail.</span><br><span class="line">                        return null;</span><br><span class="line">                    &#125;</span><br><span class="line">                    providerRunning = false;</span><br><span class="line">                    conn = null;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    cpr.proc.verifiedAdj = cpr.proc.setAdj;</span><br><span class="line">                &#125;</span><br><span class="line">                Binder.restoreCallingIdentity(origId);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>关键的步骤都在上面有中文注释，值得注意的是如果减少了引用计数之后，<strong>Client和ContentProider之间还有Connection</strong>，会导致Client进程被杀掉，所以直接返回空。</p>
<p><strong>2.ContentProvider没有在运行</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">if (!providerRunning) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        checkTime(startTime, &quot;getContentProviderImpl: before resolveContentProvider&quot;);</span><br><span class="line">        //先尝试从PackageManager中获取ContentProviderInfo</span><br><span class="line">        cpi = AppGlobals.getPackageManager().</span><br><span class="line">            resolveContentProvider(name,</span><br><span class="line">                STOCK_PM_FLAGS | PackageManager.GET_URI_PERMISSION_PATTERNS, userId);</span><br><span class="line">        checkTime(startTime, &quot;getContentProviderImpl: after resolveContentProvider&quot;);</span><br><span class="line">    &#125; catch (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    if (cpi == null) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    boolean singleton = isSingleton(cpi.processName, cpi.applicationInfo,</span><br><span class="line">            cpi.name, cpi.flags)</span><br><span class="line">            &amp;&amp; isValidSingletonCall(r.uid, cpi.applicationInfo.uid);</span><br><span class="line">    if (singleton) &#123;</span><br><span class="line">        userId = UserHandle.USER_SYSTEM;</span><br><span class="line">    &#125;</span><br><span class="line">    cpi.applicationInfo = getAppInfoForUser(cpi.applicationInfo, userId);</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: got app info for user&quot;);</span><br><span class="line">    String msg;</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: before checkContentProviderPermission&quot;);</span><br><span class="line">    if ((msg = checkContentProviderPermissionLocked(cpi, r, userId, !singleton))</span><br><span class="line">            != null) &#123;</span><br><span class="line">        throw new SecurityException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: after checkContentProviderPermission&quot;);</span><br><span class="line">    if (!mProcessesReady</span><br><span class="line">            &amp;&amp; !cpi.processName.equals(&quot;system&quot;)) &#123;</span><br><span class="line">        throw new IllegalArgumentException(</span><br><span class="line">                &quot;Attempt to launch content provider before system ready&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //如果provider的提供用户没有在运行则直接返回。</span><br><span class="line">    if (!mUserController.isUserRunningLocked(userId, 0)) &#123;</span><br><span class="line">        Slog.w(TAG, &quot;Unable to launch app &quot;</span><br><span class="line">                + cpi.applicationInfo.packageName + &quot;/&quot;</span><br><span class="line">                + cpi.applicationInfo.uid + &quot; for provider &quot;</span><br><span class="line">                + name + &quot;: user &quot; + userId + &quot; is stopped&quot;);</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line">    ComponentName comp = new ComponentName(cpi.packageName, cpi.name);</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: before getProviderByClass&quot;);</span><br><span class="line">    //尝试从通过包名从缓存中获取ContentProvider</span><br><span class="line">    cpr = mProviderMap.getProviderByClass(comp, userId);</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: after getProviderByClass&quot;);</span><br><span class="line">    final boolean firstClass = cpr == null;</span><br><span class="line">    //没有缓存在进入处理，尝试获取新的ContentProviderRecord.</span><br><span class="line">    if (firstClass) &#123;</span><br><span class="line">        final long ident = Binder.clearCallingIdentity();</span><br><span class="line">        if (mPermissionReviewRequired) &#123;</span><br><span class="line">            if (!requestTargetProviderPermissionsReviewIfNeededLocked(cpi, r, userId)) &#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            checkTime(startTime, &quot;getContentProviderImpl: before getApplicationInfo&quot;);</span><br><span class="line">            //根据包名和userId尝试获取新的ApplicationInfo.</span><br><span class="line">            ApplicationInfo ai =</span><br><span class="line">                AppGlobals.getPackageManager().</span><br><span class="line">                    getApplicationInfo(</span><br><span class="line">                            cpi.applicationInfo.packageName,</span><br><span class="line">                            STOCK_PM_FLAGS, userId);</span><br><span class="line">            checkTime(startTime, &quot;getContentProviderImpl: after getApplicationInfo&quot;);</span><br><span class="line">            //安装包中获取不到对应的信息，直接返回</span><br><span class="line">            if (ai == null) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;No package info for content provider &quot;</span><br><span class="line">                        + cpi.name);</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">            ai = getAppInfoForUser(ai, userId);</span><br><span class="line">            //封装在新的ContentProviderRecord</span><br><span class="line">            cpr = new ContentProviderRecord(this, cpi, ai, comp, singleton);</span><br><span class="line">        &#125; catch (RemoteException ex) &#123;</span><br><span class="line">            // pm is in same process, this will never happen.</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(ident);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: now have ContentProviderRecord&quot;);</span><br><span class="line">    if (r != null &amp;&amp; cpr.canRunHere(r)) &#123;</span><br><span class="line">        //如果ContentProvider声明了多进程运行或者处于同一个进程或者拥有同样的uid, 则直接返回。</span><br><span class="line">        return cpr.newHolder(null);</span><br><span class="line">    &#125;</span><br><span class="line">    if (DEBUG_PROVIDER) Slog.w(TAG_PROVIDER, &quot;LAUNCHING REMOTE PROVIDER (myuid &quot;</span><br><span class="line">                + (r != null ? r.uid : null) + &quot; pruid &quot; + cpr.appInfo.uid + &quot;): &quot;</span><br><span class="line">                + cpr.info.name + &quot; callers=&quot; + Debug.getCallers(6));</span><br><span class="line">    //如果该ContentProvider已经正在启动中，则i &lt; 正在启动的ContentProvider数。</span><br><span class="line">    final int N = mLaunchingProviders.size();</span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; i &lt; N; i++) &#123;</span><br><span class="line">        if (mLaunchingProviders.get(i) == cpr) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //没有在启动中，启动它。</span><br><span class="line">    if (i &gt;= N) &#123;</span><br><span class="line">        final long origId = Binder.clearCallingIdentity();</span><br><span class="line">        try &#123;</span><br><span class="line">            //设置包状态</span><br><span class="line">            try &#123;</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: before set stopped state&quot;);</span><br><span class="line">                AppGlobals.getPackageManager().setPackageStoppedState(</span><br><span class="line">                        cpr.appInfo.packageName, false, userId);</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: after set stopped state&quot;);</span><br><span class="line">            &#125; catch (RemoteException e) &#123;</span><br><span class="line">            &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">                Slog.w(TAG, &quot;Failed trying to unstop package &quot;</span><br><span class="line">                        + cpr.appInfo.packageName + &quot;: &quot; + e);</span><br><span class="line">            &#125;</span><br><span class="line">            //获取对应的进程信息</span><br><span class="line">            checkTime(startTime, &quot;getContentProviderImpl: looking for process record&quot;);</span><br><span class="line">            ProcessRecord proc = getProcessRecordLocked(</span><br><span class="line">                    cpi.processName, cpr.appInfo.uid, false);</span><br><span class="line"></span><br><span class="line">            if (proc != null &amp;&amp; proc.thread != null &amp;&amp; !proc.killed) &#123;</span><br><span class="line">                if (DEBUG_PROVIDER) Slog.d(TAG_PROVIDER,</span><br><span class="line">                        &quot;Installing in existing process &quot; + proc);</span><br><span class="line">                if (!proc.pubProviders.containsKey(cpi.name)) &#123;</span><br><span class="line">                    checkTime(startTime, &quot;getContentProviderImpl: scheduling install&quot;);</span><br><span class="line">                    //provider对应的进程已经启动，但是该provider还没有被publish</span><br><span class="line">                    //因此发送消息触发publish provider的操作。</span><br><span class="line">                    proc.pubProviders.put(cpi.name, cpr);</span><br><span class="line">                    try &#123;</span><br><span class="line">                        proc.thread.scheduleInstallProvider(cpi);</span><br><span class="line">                    &#125; catch (RemoteException e) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                //provider所在的进程没有启动，或者已经被杀</span><br><span class="line">                //启动provider对应的进程</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: before start process&quot;);</span><br><span class="line">                proc = startProcessLocked(cpi.processName,</span><br><span class="line">                        cpr.appInfo, false, 0, &quot;content provider&quot;,</span><br><span class="line">                        new ComponentName(cpi.applicationInfo.packageName,</span><br><span class="line">                                cpi.name), false, false, false);</span><br><span class="line">                checkTime(startTime, &quot;getContentProviderImpl: after start process&quot;);</span><br><span class="line">                if (proc == null) &#123;</span><br><span class="line">                    //无法启动，直接返回空</span><br><span class="line">                    Slog.w(TAG, &quot;Unable to launch app &quot;</span><br><span class="line">                            + cpi.applicationInfo.packageName + &quot;/&quot;</span><br><span class="line">                            + cpi.applicationInfo.uid + &quot; for provider &quot;</span><br><span class="line">                            + name + &quot;: process is bad&quot;);</span><br><span class="line">                    return null;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            //将ContentProviderRecord中保存的launchingApp设置为所在的进程，并将provider</span><br><span class="line">            //保存到正在启动的ContentProvider列表</span><br><span class="line">            cpr.launchingApp = proc;</span><br><span class="line">            mLaunchingProviders.add(cpr);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    checkTime(startTime, &quot;getContentProviderImpl: updating data structures&quot;);</span><br><span class="line">    //保存新的ContentProviderRecord到mProviderMap中。</span><br><span class="line">    if (firstClass) &#123;</span><br><span class="line">        mProviderMap.putProviderByClass(comp, cpr);</span><br><span class="line">    &#125;</span><br><span class="line">    mProviderMap.putProviderByName(name, cpr);</span><br><span class="line">    //增加Client与ContentProvider之间的引用计数。</span><br><span class="line">    conn = incProviderCountLocked(r, cpr, token, stable);</span><br><span class="line">    if (conn != null) &#123;</span><br><span class="line">        conn.waiting = true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键步骤在文中有注释，主要流程是:</p>
<ul>
<li>权限检查</li>
<li>通过PM获取对应provider信息</li>
<li>检查provider是否能够正常运行</li>
<li>启动对应的进程，然后publish provider</li>
<li>更新包状态、缓存、引用计数。</li>
</ul>
<p><strong>3. 轮询确保provider被publish完成</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">synchronized (cpr) &#123;</span><br><span class="line">    while (cpr.provider == null) &#123;</span><br><span class="line">        //provider所在进程已经不存在则直接返回</span><br><span class="line">        if (cpr.launchingApp == null) &#123;</span><br><span class="line">            Slog.w(TAG, &quot;Unable to launch app &quot;</span><br><span class="line">                    + cpi.applicationInfo.packageName + &quot;/&quot;</span><br><span class="line">                    + cpi.applicationInfo.uid + &quot; for provider &quot;</span><br><span class="line">                    + name + &quot;: launching app became null&quot;);</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PROVIDER_LOST_PROCESS,</span><br><span class="line">                    UserHandle.getUserId(cpi.applicationInfo.uid),</span><br><span class="line">                    cpi.applicationInfo.packageName,</span><br><span class="line">                    cpi.applicationInfo.uid, name);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (DEBUG_MU) Slog.v(TAG_MU,</span><br><span class="line">                    &quot;Waiting to start provider &quot; + cpr</span><br><span class="line">                    + &quot; launchingApp=&quot; + cpr.launchingApp);</span><br><span class="line">            //Client与ContentProvider之间有引用时才执行</span><br><span class="line">            if (conn != null) &#123;</span><br><span class="line">                conn.waiting = true;</span><br><span class="line">            &#125;</span><br><span class="line">            cpr.wait();</span><br><span class="line">        &#125; catch (InterruptedException ex) &#123;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            if (conn != null) &#123;</span><br><span class="line">                conn.waiting = false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">return cpr != null ? cpr.newHolder(conn) : null;</span><br></pre></td></tr></table></figure>
<p>概要总结getContentProviderImpl是如何实现获取ContentProvider： <strong>总是先尝试从缓存中获取已经publish的provider，并返回；如果缓存中不存在才尝试创建新的provider并启动对应的进程。</strong></p>
<h6 id="第三部分：执行ActivityThread-installProvider"><a href="#第三部分：执行ActivityThread-installProvider" class="headerlink" title="第三部分：执行ActivityThread.installProvider()"></a>第三部分：执行ActivityThread.installProvider()</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">private ContentProviderHolder installProvider(Context context,</span><br><span class="line">         ContentProviderHolder holder, ProviderInfo info,</span><br><span class="line">         boolean noisy, boolean noReleaseNeeded, boolean stable) &#123;</span><br><span class="line">     ContentProvider localProvider = null;</span><br><span class="line">     IContentProvider provider;</span><br><span class="line">     if (holder == null || holder.provider == null) &#123;</span><br><span class="line">         //本地provider</span><br><span class="line">         if (DEBUG_PROVIDER || noisy) &#123;</span><br><span class="line">             Slog.d(TAG, &quot;Loading provider &quot; + info.authority + &quot;: &quot;</span><br><span class="line">                     + info.name);</span><br><span class="line">         &#125;</span><br><span class="line">         Context c = null;</span><br><span class="line">         ApplicationInfo ai = info.applicationInfo;</span><br><span class="line">         //provider与caller在同一个包内</span><br><span class="line">         if (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">             c = context;</span><br><span class="line">         &#125; else if (mInitialApplication != null &amp;&amp;</span><br><span class="line">                 mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">             c = mInitialApplication;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 c = context.createPackageContext(ai.packageName,</span><br><span class="line">                         Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">             &#125; catch (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">                 // Ignore</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         if (c == null) &#123;</span><br><span class="line">             Slog.w(TAG, &quot;Unable to get context for package &quot; +</span><br><span class="line">                   ai.packageName +</span><br><span class="line">                   &quot; while loading content provider &quot; +</span><br><span class="line">                   info.name);</span><br><span class="line">             return null;</span><br><span class="line">         &#125;</span><br><span class="line">         if (info.splitName != null) &#123;</span><br><span class="line">             try &#123;</span><br><span class="line">                 c = c.createContextForSplit(info.splitName);</span><br><span class="line">             &#125; catch (NameNotFoundException e) &#123;</span><br><span class="line">                 throw new RuntimeException(e);</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         //创建本地provider</span><br><span class="line">         try &#123;</span><br><span class="line">             final java.lang.ClassLoader cl = c.getClassLoader();</span><br><span class="line">             localProvider = (ContentProvider)cl.</span><br><span class="line">                 loadClass(info.name).newInstance();</span><br><span class="line">             provider = localProvider.getIContentProvider();</span><br><span class="line">             if (provider == null) &#123;</span><br><span class="line">                 Slog.e(TAG, &quot;Failed to instantiate class &quot; +</span><br><span class="line">                       info.name + &quot; from sourceDir &quot; +</span><br><span class="line">                       info.applicationInfo.sourceDir);</span><br><span class="line">                 return null;</span><br><span class="line">             &#125;</span><br><span class="line">             if (DEBUG_PROVIDER) Slog.v(</span><br><span class="line">                 TAG, &quot;Instantiating local provider &quot; + info.name);</span><br><span class="line">             // XXX Need to create the correct context for this provider.</span><br><span class="line">             //创建本地ContentProvider的Context</span><br><span class="line">             localProvider.attachInfo(c, info);</span><br><span class="line">         &#125; catch (java.lang.Exception e) &#123;</span><br><span class="line">             if (!mInstrumentation.onException(null, e)) &#123;</span><br><span class="line">                 throw new RuntimeException(</span><br><span class="line">                         &quot;Unable to get provider &quot; + info.name</span><br><span class="line">                         + &quot;: &quot; + e.toString(), e);</span><br><span class="line">             &#125;</span><br><span class="line">             return null;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         //来自本App外的ContentProvider</span><br><span class="line">         provider = holder.provider;</span><br><span class="line">         if (DEBUG_PROVIDER) Slog.v(TAG, &quot;Installing external provider &quot; + info.authority + &quot;: &quot;</span><br><span class="line">                 + info.name);</span><br><span class="line">     &#125;</span><br><span class="line">     ContentProviderHolder retHolder;</span><br><span class="line">     synchronized (mProviderMap) &#123;</span><br><span class="line">         if (DEBUG_PROVIDER) Slog.v(TAG, &quot;Checking to add &quot; + provider</span><br><span class="line">                 + &quot; / &quot; + info.name);</span><br><span class="line">         IBinder jBinder = provider.asBinder();</span><br><span class="line">         if (localProvider != null) &#123;</span><br><span class="line">             //本地provider分支</span><br><span class="line">             ComponentName cname = new ComponentName(info.packageName, info.name);</span><br><span class="line">             ProviderClientRecord pr = mLocalProvidersByName.get(cname);</span><br><span class="line">             if (pr != null) &#123;</span><br><span class="line">                 //缓存中已经存在本地provider实例。</span><br><span class="line">                 if (DEBUG_PROVIDER) &#123;</span><br><span class="line">                     Slog.v(TAG, &quot;installProvider: lost the race, &quot;</span><br><span class="line">                             + &quot;using existing local provider&quot;);</span><br><span class="line">                 &#125;</span><br><span class="line">                 provider = pr.mProvider;</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 //不存在，创建新的Client provider record并install，</span><br><span class="line">                 //然后保存到本地的缓存中</span><br><span class="line">                 holder = new ContentProviderHolder(info);</span><br><span class="line">                 holder.provider = provider;</span><br><span class="line">                 holder.noReleaseNeeded = true;</span><br><span class="line">                 pr = installProviderAuthoritiesLocked(provider, localProvider, holder);</span><br><span class="line">                 mLocalProviders.put(jBinder, pr);</span><br><span class="line">                 mLocalProvidersByName.put(cname, pr);</span><br><span class="line">             &#125;</span><br><span class="line">             //返回值为install过的本地Content Provider Holder</span><br><span class="line">             retHolder = pr.mHolder;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             ProviderRefCount prc = mProviderRefCountMap.get(jBinder);</span><br><span class="line">             if (prc != null) &#123;</span><br><span class="line">                 //不为空，说明本地provider 引用缓存中已经保存有该provider的引用计数。</span><br><span class="line">                 if (DEBUG_PROVIDER) &#123;</span><br><span class="line">                     Slog.v(TAG, &quot;installProvider: lost the race, updating ref count&quot;);</span><br><span class="line">                 &#125;</span><br><span class="line">                 //外部provider则增加引用计数。</span><br><span class="line">                 if (!noReleaseNeeded) &#123;</span><br><span class="line">                     incProviderRefLocked(prc, stable);</span><br><span class="line">                     try &#123;</span><br><span class="line">                         ActivityManager.getService().removeContentProvider(</span><br><span class="line">                                 holder.connection, stable);</span><br><span class="line">                     &#125; catch (RemoteException e) &#123;</span><br><span class="line">                         //do nothing content provider object is dead any way</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125; else &#123;</span><br><span class="line">                 ProviderClientRecord client = installProviderAuthoritiesLocked(</span><br><span class="line">                         provider, localProvider, holder);</span><br><span class="line">                 if (noReleaseNeeded) &#123;</span><br><span class="line">                     //本地provider或者来自系统的provider</span><br><span class="line">                     prc = new ProviderRefCount(holder, client, 1000, 1000);</span><br><span class="line">                 &#125; else &#123;</span><br><span class="line">                     //其他App的provider</span><br><span class="line">                     prc = stable</span><br><span class="line">                             ? new ProviderRefCount(holder, client, 1, 0)</span><br><span class="line">                             : new ProviderRefCount(holder, client, 0, 1);</span><br><span class="line">                 &#125;</span><br><span class="line">                 //在本App的缓存中保存provider的引用计数。</span><br><span class="line">                 mProviderRefCountMap.put(jBinder, prc);</span><br><span class="line">             &#125;</span><br><span class="line">             retHolder = prc.holder;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return retHolder;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>对于本地ContentProvider, <strong>installProvider</strong>做的事情是先创建一个本地provider，并将相应的内容（IContentProvider接口、本地ContentProvider实例等）保存到本App的缓存当中；对于外部的ContentProvider，<strong>installProvider</strong>做的事情则是在本App的缓存当中保存provider的引用计数。</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 gitcoment -->
<div id="gitment-comment">
    <!-- Gitment 评论框 -->
<div id="container"></div>
</div>
<style>
    #gitment-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        //id: '页面 ID', // 可选。默认为 location.href
        // id: 'ContentProvider系列1-获取ContentProvider'
        owner: 'wusp',
        repo: 'wusp.github.io',
        oauth: {
            client_id: 'cf3aa4df893d2a607397',
            client_secret: 'ea14eb0d93e926c0bb54eb827f24877a0091e129',
        },
    })
    gitment.render('container')
</script>


                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/01/27/SettingsProvider2/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/01/23/ART-Configuration1/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/wusp.jpg" alt="wusp's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        podussily@163.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Archives  -->
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/categories/Kotlin/">Kotlin<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/categories/Network/">Network<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/并发编程/">并发编程<span class="sidebar_archives-count">2</span></a>
            </ul>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">22</span>
            </a>
        </li>
        
            <li class="divider"></li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

    <a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        sidebar.help
        <span class="mdl-button__ripple-container">
          <span class="mdl-ripple"></span>
        </span>
      </div>
    </a>

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

    <a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
             sidebar.about_theme
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
    </a>

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://www.github.com/wusp" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>wusp Blog
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- Gitment -->





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->


    
        <script>lsloader.load("hanabi","/js/hanabi-browser-bundle.js?Pki5+pzkluqu53g+ouMWpA==", true)</script>
    


<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
        
            HanabiBrowser.clearColors();
        
        
        HanabiBrowser.start('pre code',false);
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
