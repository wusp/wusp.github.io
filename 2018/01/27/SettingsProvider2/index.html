<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            SettingsProvider系列2-重要的几个API方法 | 
        
        wusp Blog
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="wusp Blog">
    <meta name="msapplication-starturl" content="http://yoursite.com/2018/01/27/SettingsProvider2/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="wusp Blog">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com/2018/01/27/SettingsProvider2/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="SettingsProvider系列2-重要的几个API方法 | wusp Blog">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    

    
        <meta property="article:published_time" content="Sat Jan 27 2018 01:13:52 GMT+0800">
        <meta property="article:modified_time" content="Sat Jan 27 2018 01:17:03 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/01/27/SettingsProvider2/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2018/01/27/SettingsProvider2/index.html",
    "headline": "SettingsProvider系列2-重要的几个API方法",
    "datePublished": "Sat Jan 27 2018 01:13:52 GMT+0800",
    "dateModified": "Sat Jan 27 2018 01:17:03 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "wusp",
        "image": {
            "@type": "ImageObject",
            "url": "/img/wusp.jpg"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "wusp Blog",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": "",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-6"><a class="post-toc-link" href="#本文源码基于Android-4-2"><span class="post-toc-number">1.</span> <span class="post-toc-text">本文源码基于Android 4.2</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#onCreate"><span class="post-toc-number"></span> <span class="post-toc-text">onCreate()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#query"><span class="post-toc-number"></span> <span class="post-toc-text">query()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#insert"><span class="post-toc-number"></span> <span class="post-toc-text">insert()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#delete"><span class="post-toc-number"></span> <span class="post-toc-text">delete()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#update"><span class="post-toc-number"></span> <span class="post-toc-text">update()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#call"><span class="post-toc-number"></span> <span class="post-toc-text">call()</span></a>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                SettingsProvider系列2-重要的几个API方法
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/wusp.jpg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>wusp</strong>
        <span>1月 27, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=SettingsProvider系列2-重要的几个API方法&url=http://yoursite.com/2018/01/27/SettingsProvider2/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=SettingsProvider系列2-重要的几个API方法&url=http://yoursite.com/2018/01/27/SettingsProvider2/index.html&via=wusp" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/01/27/SettingsProvider2/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/01/27/SettingsProvider2/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h6 id="本文源码基于Android-4-2"><a href="#本文源码基于Android-4-2" class="headerlink" title="本文源码基于Android 4.2"></a>本文源码基于Android 4.2</h6><h3 id="onCreate"><a href="#onCreate" class="headerlink" title="onCreate()"></a>onCreate()</h3><p>既然SettingsProvider是一个ContentProvider，那么对onCreate()的回调肯定是其生命周期中不可或缺的一步。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean onCreate() &#123;</span><br><span class="line">    //初始化BackupManager</span><br><span class="line">    mBackupManager = new BackupManager(getContext());</span><br><span class="line">    //初始化UserManager</span><br><span class="line">    mUserManager = (UserManager) getContext().getSystemService(Context.USER_SERVICE);</span><br><span class="line">    //确保创建ANDROID_ID;</span><br><span class="line">    //创建UserHandle对应的DatabaseHelper缓存</span><br><span class="line">    //将Global、System、Secure中的内容dump到对应的缓存中。</span><br><span class="line">    establishDbTracking(UserHandle.USER_OWNER);</span><br><span class="line">    //注册广播接收器，接收UserHandle移除事件。</span><br><span class="line">    //原因是当UserHandle需要将UserHandle对应的缓存移除。</span><br><span class="line">    IntentFilter userFilter = new IntentFilter();</span><br><span class="line">    userFilter.addAction(Intent.ACTION_USER_REMOVED);</span><br><span class="line">    getContext().registerReceiver(new BroadcastReceiver() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onReceive(Context context, Intent intent) &#123;</span><br><span class="line">            if (intent.getAction().equals(Intent.ACTION_USER_REMOVED)) &#123;</span><br><span class="line">                final int userHandle = intent.getIntExtra(Intent.EXTRA_USER_HANDLE,</span><br><span class="line">                        UserHandle.USER_OWNER);</span><br><span class="line">                if (userHandle != UserHandle.USER_OWNER) &#123;</span><br><span class="line">                    //设备拥有者不用移除</span><br><span class="line">                    onUserRemoved(userHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, userFilter);</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中比较重要的便是establishDbTracking函数，该函数完成了很多初始化准备工作。</p>
<ul>
<li><strong>establishDbTracking(int userHandle)</strong> 为UserHandle创建相应的SYSTEM和SECURE缓存，GLOBAL则属于USER_OWNER，因此是所有User共享的。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">DatabaseHelper dbhelper;</span><br><span class="line">//获取UserId对应的DataBaseHelper</span><br><span class="line">synchronized (this) &#123;</span><br><span class="line">    //先从缓存中获取</span><br><span class="line">    dbhelper = mOpenHelpers.get(userHandle);</span><br><span class="line">    if (dbhelper == null) &#123;</span><br><span class="line">        //获取不到则重新创建一个</span><br><span class="line">        dbhelper = new DatabaseHelper(getContext(), userHandle);</span><br><span class="line">        mOpenHelpers.append(userHandle, dbhelper);</span><br><span class="line"></span><br><span class="line">        sSystemCaches.append(userHandle, new SettingsCache(TABLE_SYSTEM));</span><br><span class="line">        sSecureCaches.append(userHandle, new SettingsCache(TABLE_SECURE));</span><br><span class="line">        sKnownMutationsInFlight.append(userHandle, new AtomicInteger(0));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//通过DataBaseOpenHelper获取可写DB</span><br><span class="line">SQLiteDatabase db = dbhelper.getWritableDatabase();</span><br><span class="line">// Watch for external modifications to the database files,</span><br><span class="line">// keeping our caches in sync.  We synchronize the observer set</span><br><span class="line">// separately, and of course it has to run after the db file</span><br><span class="line">// itself was set up by the DatabaseHelper.</span><br><span class="line">synchronized (sObserverInstances) &#123;</span><br><span class="line">    if (sObserverInstances.get(userHandle) == null) &#123;</span><br><span class="line">        SettingsFileObserver observer = new SettingsFileObserver(userHandle, db.getPath());</span><br><span class="line">        sObserverInstances.append(userHandle, observer);</span><br><span class="line">        observer.startWatching();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//device第一次boot时为UserHandle生成一个对应的随机64 ID，并保存到Secure中</span><br><span class="line">ensureAndroidIdIsSet(userHandle);</span><br><span class="line">//开启一个线程来异步将Settings几个表中（/global,/secure,/system）的内容填充到缓存当中。</span><br><span class="line">startAsyncCachePopulation(userHandle);</span><br></pre></td></tr></table></figure>
<h3 id="query"><a href="#query" class="headerlink" title="query()"></a>query()</h3><p>接下来便是几乎在所有ContentProvider中调用频率都是最高的查询函数query()。query()直接进入到queryForUser()中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">private Cursor queryForUser(Uri url, String[] select, String where, String[] whereArgs,</span><br><span class="line">        String sort, int forUser) &#123;</span><br><span class="line">    if (LOCAL_LOGV) Slog.v(TAG, &quot;query(&quot; + url + &quot;) for user &quot; + forUser);</span><br><span class="line">    //解析content://settings/xxx, 条件语句和条件的值都Sql查询语句。</span><br><span class="line">    SqlArguments args = new SqlArguments(url, where, whereArgs);</span><br><span class="line">    DatabaseHelper dbH;</span><br><span class="line">    //通过UserHandle获取对应的DatabaseHelper，Global表属于整个设备。</span><br><span class="line">    dbH = getOrEstablishDatabase(</span><br><span class="line">            TABLE_GLOBAL.equals(args.table) ? UserHandle.USER_OWNER : forUser);</span><br><span class="line">    SQLiteDatabase db = dbH.getReadableDatabase();</span><br><span class="line"></span><br><span class="line">    // The favorites table was moved from this provider to a provider inside Home</span><br><span class="line">    // Home still need to query this table to upgrade from pre-cupcake builds</span><br><span class="line">    // However, a cupcake+ build with no data does not contain this table which will</span><br><span class="line">    // cause an exception in the SQL stack. The following line is a special case to</span><br><span class="line">    // let the caller of the query have a chance to recover and avoid the exception</span><br><span class="line">    if (TABLE_FAVORITES.equals(args.table)) &#123;</span><br><span class="line">        return null;</span><br><span class="line">    &#125; else if (TABLE_OLD_FAVORITES.equals(args.table)) &#123;</span><br><span class="line">        args.table = TABLE_FAVORITES;</span><br><span class="line">        Cursor cursor = db.rawQuery(&quot;PRAGMA table_info(favorites);&quot;, null);</span><br><span class="line">        if (cursor != null) &#123;</span><br><span class="line">            boolean exists = cursor.getCount() &gt; 0;</span><br><span class="line">            cursor.close();</span><br><span class="line">            if (!exists) return null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SQLiteQueryBuilder qb = new SQLiteQueryBuilder();</span><br><span class="line">    qb.setTables(args.table);</span><br><span class="line">    //查表返回Cursor</span><br><span class="line">    Cursor ret = qb.query(db, select, args.where, args.args, null, null, sort);</span><br><span class="line">    // the default Cursor interface does not support per-user observation</span><br><span class="line">    try &#123;</span><br><span class="line">        AbstractCursor c = (AbstractCursor) ret;</span><br><span class="line">        c.setNotificationUri(getContext().getContentResolver(), url, forUser);</span><br><span class="line">    &#125; catch (ClassCastException e) &#123;</span><br><span class="line">        // details of the concrete Cursor implementation have changed and this code has</span><br><span class="line">        // not been updated to match -- complain and fail hard.</span><br><span class="line">        Log.wtf(TAG, &quot;Incompatible cursor derivation!&quot;);</span><br><span class="line">        throw e;</span><br><span class="line">    &#125;</span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过获取缓存中的DatabaseHelper（没有则创建）来查询数据库。</p>
<h3 id="insert"><a href="#insert" class="headerlink" title="insert()"></a>insert()</h3><p>insert()最终也是进入到insertForUser()当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">final int callingUser = UserHandle.getCallingUserId();</span><br><span class="line">if (callingUser != desiredUserHandle) &#123;</span><br><span class="line">    getContext().enforceCallingOrSelfPermission(</span><br><span class="line">            android.Manifest.permission.INTERACT_ACROSS_USERS_FULL,</span><br><span class="line">            &quot;Not permitted to access settings for other users&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (LOCAL_LOGV) Slog.v(TAG, &quot;insert(&quot; + url + &quot;) for user &quot; + desiredUserHandle</span><br><span class="line">        + &quot; by &quot; + callingUser);</span><br><span class="line">//将Uri 转换成SQL语句</span><br><span class="line">SqlArguments args = new SqlArguments(url);</span><br><span class="line">//favorite表已经迁移，直接返回。</span><br><span class="line">if (TABLE_FAVORITES.equals(args.table)) &#123;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Location providers的处理。</span><br><span class="line">// Android的位置服务都是由一堆的provider来提供。</span><br><span class="line">// Support enabling/disabling a single provider (using &quot;+&quot; or &quot;-&quot; prefix)</span><br><span class="line">String name = initialValues.getAsString(Settings.Secure.NAME);</span><br><span class="line">if (Settings.Secure.LOCATION_PROVIDERS_ALLOWED.equals(name)) &#123;</span><br><span class="line">    if (!parseProviderList(url, initialValues)) return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//对于已经迁移到Global表中的Key/Value，则直接写入到Global表中。</span><br><span class="line">if (name != null) &#123;</span><br><span class="line">    if (sSecureGlobalKeys.contains(name) || sSystemGlobalKeys.contains(name)) &#123;</span><br><span class="line">        if (!TABLE_GLOBAL.equals(args.table)) &#123;</span><br><span class="line">            if (LOCAL_LOGV) Slog.i(TAG, &quot;Rewrite of insert() of now-global key &quot; + name);</span><br><span class="line">        &#125;</span><br><span class="line">        args.table = TABLE_GLOBAL;  // next condition will rewrite the user handle</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Check write permissions only after determining which table the insert will touch</span><br><span class="line">checkWritePermissions(args);</span><br><span class="line">// The global table is stored under the owner, always</span><br><span class="line">if (TABLE_GLOBAL.equals(args.table)) &#123;</span><br><span class="line">    desiredUserHandle = UserHandle.USER_OWNER;</span><br><span class="line">&#125;</span><br><span class="line">//寻找到table对应的LRU SettingsCache</span><br><span class="line">SettingsCache cache = cacheForTable(desiredUserHandle, args.table);</span><br><span class="line">String value = initialValues.getAsString(Settings.NameValueTable.VALUE);</span><br><span class="line">if (SettingsCache.isRedundantSetValue(cache, name, value)) &#123;</span><br><span class="line">    //该Key/Value在对应的SettingsCache中已经存在，直接返回对应的Uri</span><br><span class="line">    return Uri.withAppendedPath(url, name);</span><br><span class="line">&#125;</span><br><span class="line">//UserHandle正在操作的计数 + 1</span><br><span class="line">final AtomicInteger mutationCount = sKnownMutationsInFlight.get(desiredUserHandle);</span><br><span class="line">mutationCount.incrementAndGet();</span><br><span class="line">//获取UserHandle对应的DatabaseHelper和DB</span><br><span class="line">DatabaseHelper dbH = getOrEstablishDatabase(desiredUserHandle);</span><br><span class="line">SQLiteDatabase db = dbH.getWritableDatabase();</span><br><span class="line">//插入进去</span><br><span class="line">final long rowId = db.insert(args.table, null, initialValues);</span><br><span class="line">//UserHandle正在操作的计数 - 1</span><br><span class="line">mutationCount.decrementAndGet();</span><br><span class="line">//插入失败，返回空</span><br><span class="line">if (rowId &lt;= 0) return null;</span><br><span class="line">//保存Key/Value到SettingsCache中。</span><br><span class="line">SettingsCache.populate(cache, initialValues);  // before we notify</span><br><span class="line">if (LOCAL_LOGV) Log.v(TAG, args.table + &quot; &lt;- &quot; + initialValues</span><br><span class="line">        + &quot; for user &quot; + desiredUserHandle);</span><br><span class="line">// Note that we use the original url here, not the potentially-rewritten table name</span><br><span class="line">//封装Uri</span><br><span class="line">url = getUriFor(url, initialValues, rowId);</span><br><span class="line">//notify一些重要的监听者</span><br><span class="line">//比如BackUpManager、ContentResolver框架、SystemProperties的监听者。</span><br><span class="line">sendNotify(url, desiredUserHandle);</span><br><span class="line">return url;</span><br></pre></td></tr></table></figure>
<p>这里主要做了几件事情：（1）权限检查；（2）处理位置相关的provider；（3）处理Global表的迁移；（4）如果是新的值则插入到DB；(5) 写入到缓存；（6）通知一些监听Key/Value值变化的人，具体在下面：</p>
<ul>
<li><strong>sendNotify()</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//获取不同表在SystemProperties中的监视点，</span><br><span class="line">//该值变化时，对应的监听者会重新获取新的值。</span><br><span class="line">//只针对Global、System、Secure</span><br><span class="line">boolean backedUpDataChanged = false;</span><br><span class="line">String property = null, table = uri.getPathSegments().get(0);</span><br><span class="line">final boolean isGlobal = table.equals(TABLE_GLOBAL);</span><br><span class="line">if (table.equals(TABLE_SYSTEM)) &#123;</span><br><span class="line">    property = Settings.System.SYS_PROP_SETTING_VERSION;</span><br><span class="line">    backedUpDataChanged = true;</span><br><span class="line">&#125; else if (table.equals(TABLE_SECURE)) &#123;</span><br><span class="line">    property = Settings.Secure.SYS_PROP_SETTING_VERSION;</span><br><span class="line">    backedUpDataChanged = true;</span><br><span class="line">&#125; else if (isGlobal) &#123;</span><br><span class="line">    property = Settings.Global.SYS_PROP_SETTING_VERSION;    // this one is global</span><br><span class="line">    backedUpDataChanged = true;</span><br><span class="line">&#125;</span><br><span class="line">//通知对应的监听者。</span><br><span class="line">if (property != null) &#123;</span><br><span class="line">    long version = SystemProperties.getLong(property, 0) + 1;</span><br><span class="line">    if (LOCAL_LOGV) Log.v(TAG, &quot;property: &quot; + property + &quot;=&quot; + version);</span><br><span class="line">    SystemProperties.set(property, Long.toString(version));</span><br><span class="line">&#125;</span><br><span class="line">// Inform the backup manager about a data change</span><br><span class="line">if (backedUpDataChanged) &#123;</span><br><span class="line">    mBackupManager.dataChanged();</span><br><span class="line">&#125;</span><br><span class="line">// Now send the notification through the content framework.</span><br><span class="line">String notify = uri.getQueryParameter(&quot;notify&quot;);</span><br><span class="line">if (notify == null || &quot;true&quot;.equals(notify)) &#123;</span><br><span class="line">    final int notifyTarget = isGlobal ? UserHandle.USER_ALL : userHandle;</span><br><span class="line">    final long oldId = Binder.clearCallingIdentity();</span><br><span class="line">    try &#123;</span><br><span class="line">        getContext().getContentResolver().notifyChange(uri, null, true, notifyTarget);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(oldId);</span><br><span class="line">    &#125;</span><br><span class="line">    if (LOCAL_LOGV) Log.v(TAG, &quot;notifying for &quot; + notifyTarget + &quot;: &quot; + uri);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if (LOCAL_LOGV) Log.v(TAG, &quot;notification suppressed: &quot; + uri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是三个，BackUpManager、ContentResolver框架、通过SystemProperties监听Settings变化的组件。<strong>后期定制化SettingsProvider时可以在这里加上自己的监听者</strong>。</p>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete()"></a>delete()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">int callingUser = UserHandle.getCallingUserId();</span><br><span class="line">if (LOCAL_LOGV) Slog.v(TAG, &quot;delete() for user &quot; + callingUser);</span><br><span class="line">SqlArguments args = new SqlArguments(url, where, whereArgs);</span><br><span class="line">//处理已经迁移的favorite和特殊的Global</span><br><span class="line">if (TABLE_FAVORITES.equals(args.table)) &#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125; else if (TABLE_OLD_FAVORITES.equals(args.table)) &#123;</span><br><span class="line">    args.table = TABLE_FAVORITES;</span><br><span class="line">&#125; else if (TABLE_GLOBAL.equals(args.table)) &#123;</span><br><span class="line">    callingUser = UserHandle.USER_OWNER;</span><br><span class="line">&#125;</span><br><span class="line">checkWritePermissions(args);</span><br><span class="line">//操作计数</span><br><span class="line">final AtomicInteger mutationCount = sKnownMutationsInFlight.get(callingUser);</span><br><span class="line">mutationCount.incrementAndGet();</span><br><span class="line">DatabaseHelper dbH = getOrEstablishDatabase(callingUser);</span><br><span class="line">SQLiteDatabase db = dbH.getWritableDatabase();</span><br><span class="line">//删除</span><br><span class="line">int count = db.delete(args.table, args.where, args.args);</span><br><span class="line">mutationCount.decrementAndGet();</span><br><span class="line">if (count &gt; 0) &#123;</span><br><span class="line">    //删除成功，移除所有LRU Settings cache</span><br><span class="line">    invalidateCache(callingUser, args.table);  // before we notify</span><br><span class="line">    //通知</span><br><span class="line">    sendNotify(url, callingUser);</span><br><span class="line">&#125;</span><br><span class="line">//重新从表中获取所有的的值到Settings cache中。</span><br><span class="line">startAsyncCachePopulation(callingUser);</span><br><span class="line">if (LOCAL_LOGV) Log.v(TAG, args.table + &quot;: &quot; + count + &quot; row(s) deleted&quot;);</span><br><span class="line">return count;</span><br></pre></td></tr></table></figure>
<p>delete的流程很多地方跟insert很相似。<strong>值得注意的是，在删除后，会先清空该表在LRU SettingsCache中对应UserHandle所Mapping的所有的值，然后再异步从DB中重新全部读取一遍。</strong></p>
<h3 id="update"><a href="#update" class="headerlink" title="update()"></a>update()</h3><p>update()的流程跟delete()近乎一致，而且使用的地方也非常少，就此略过。</p>
<h3 id="call"><a href="#call" class="headerlink" title="call()"></a>call()</h3><p>该方法主要提供给adb shell commands使用，提供一种快速获取Settings中Key/Value的方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">public Bundle call(String method, String request, Bundle args) &#123;</span><br><span class="line">    int callingUser = UserHandle.getCallingUserId();</span><br><span class="line">    //获取正确的UserHandle</span><br><span class="line">    if (args != null) &#123;</span><br><span class="line">        int reqUser = args.getInt(Settings.CALL_METHOD_USER_KEY, callingUser);</span><br><span class="line">        if (reqUser != callingUser) &#123;</span><br><span class="line">            callingUser = ActivityManager.handleIncomingUser(Binder.getCallingPid(),</span><br><span class="line">                    Binder.getCallingUid(), reqUser, false, true,</span><br><span class="line">                    &quot;get/set setting for user&quot;, null);</span><br><span class="line">            if (LOCAL_LOGV) Slog.v(TAG, &quot;   access setting for user &quot; + callingUser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //获取对应的DatabaseHelper和SettingsCache</span><br><span class="line">    DatabaseHelper dbHelper;</span><br><span class="line">    SettingsCache cache;</span><br><span class="line">    //get方法</span><br><span class="line">    if (Settings.CALL_METHOD_GET_SYSTEM.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call(system:&quot; + request + &quot;) for &quot; + callingUser);</span><br><span class="line">        dbHelper = getOrEstablishDatabase(callingUser);</span><br><span class="line">        cache = sSystemCaches.get(callingUser);</span><br><span class="line">        return lookupValue(dbHelper, TABLE_SYSTEM, cache, request);</span><br><span class="line">    &#125;</span><br><span class="line">    if (Settings.CALL_METHOD_GET_SECURE.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call(secure:&quot; + request + &quot;) for &quot; + callingUser);</span><br><span class="line">        dbHelper = getOrEstablishDatabase(callingUser);</span><br><span class="line">        cache = sSecureCaches.get(callingUser);</span><br><span class="line">        return lookupValue(dbHelper, TABLE_SECURE, cache, request);</span><br><span class="line">    &#125;</span><br><span class="line">    if (Settings.CALL_METHOD_GET_GLOBAL.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call(global:&quot; + request + &quot;) for &quot; + callingUser);</span><br><span class="line">        // fast path: owner db &amp; cache are immutable after onCreate() so we need not</span><br><span class="line">        // guard on the attempt to look them up</span><br><span class="line">        return lookupValue(getOrEstablishDatabase(UserHandle.USER_OWNER), TABLE_GLOBAL,</span><br><span class="line">                sGlobalCache, request);</span><br><span class="line">    &#125;</span><br><span class="line">    //put方法</span><br><span class="line">    final String newValue = (args == null)</span><br><span class="line">    ? null : args.getString(Settings.NameValueTable.VALUE);</span><br><span class="line">    final ContentValues values = new ContentValues();</span><br><span class="line">    values.put(Settings.NameValueTable.NAME, request);</span><br><span class="line">    values.put(Settings.NameValueTable.VALUE, newValue);</span><br><span class="line">    //调用insertForUser插入</span><br><span class="line">    if (Settings.CALL_METHOD_PUT_SYSTEM.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call_put(system:&quot; + request + &quot;=&quot; + newValue + &quot;) for &quot; + callingUser);</span><br><span class="line">        insertForUser(Settings.System.CONTENT_URI, values, callingUser);</span><br><span class="line">    &#125; else if (Settings.CALL_METHOD_PUT_SECURE.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call_put(secure:&quot; + request + &quot;=&quot; + newValue + &quot;) for &quot; + callingUser);</span><br><span class="line">        insertForUser(Settings.Secure.CONTENT_URI, values, callingUser);</span><br><span class="line">    &#125; else if (Settings.CALL_METHOD_PUT_GLOBAL.equals(method)) &#123;</span><br><span class="line">        if (LOCAL_LOGV) Slog.v(TAG, &quot;call_put(global:&quot; + request + &quot;=&quot; + newValue + &quot;) for &quot; + callingUser);</span><br><span class="line">        insertForUser(Settings.Global.CONTENT_URI, values, callingUser);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        Slog.w(TAG, &quot;call() with invalid method: &quot; + method);</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先转化UserHandle, 再根据不同的方法进行后续的执行：get — lookupValue; put – insertForUser.<br><strong>insertForUser</strong>上面已经介绍过。<strong>lookupValue</strong>则是具体查Key对应Value值的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">private Bundle lookupValue(DatabaseHelper dbHelper, String table,</span><br><span class="line">        final SettingsCache cache, String key) &#123;</span><br><span class="line">    if (cache == null) &#123;</span><br><span class="line">       Slog.e(TAG, &quot;cache is null for user &quot; + UserHandle.getCallingUserId() + &quot; : key=&quot; + key);</span><br><span class="line">       return null;</span><br><span class="line">    &#125;</span><br><span class="line">    //先尝试从SettingsCache中获取</span><br><span class="line">    synchronized (cache) &#123;</span><br><span class="line">        Bundle value = cache.get(key);</span><br><span class="line">        if (value != null) &#123;</span><br><span class="line">            if (value != TOO_LARGE_TO_CACHE_MARKER) &#123;</span><br><span class="line">                return value;</span><br><span class="line">            &#125;</span><br><span class="line">            // else we fall through and read the value from disk</span><br><span class="line">        &#125; else if (cache.fullyMatchesDisk()) &#123;</span><br><span class="line">            // Fast path (very common).  Don&apos;t even try touch disk</span><br><span class="line">            // if we know we&apos;ve slurped it all in.  Trying to</span><br><span class="line">            // touch the disk would mean waiting for yaffs2 to</span><br><span class="line">            // give us access, which could takes hundreds of</span><br><span class="line">            // milliseconds.  And we&apos;re very likely being called</span><br><span class="line">            // from somebody&apos;s UI thread...</span><br><span class="line">            return NULL_SETTING;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //缓存中不存在再尝试从DB中获取，并保存到SettingsCache中。</span><br><span class="line">    SQLiteDatabase db = dbHelper.getReadableDatabase();</span><br><span class="line">    Cursor cursor = null;</span><br><span class="line">    try &#123;</span><br><span class="line">        cursor = db.query(table, COLUMN_VALUE, &quot;name=?&quot;, new String[]&#123;key&#125;,</span><br><span class="line">                          null, null, null, null);</span><br><span class="line">        if (cursor != null &amp;&amp; cursor.getCount() == 1) &#123;</span><br><span class="line">            cursor.moveToFirst();</span><br><span class="line">            return cache.putIfAbsent(key, cursor.getString(0));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (SQLiteException e) &#123;</span><br><span class="line">        Log.w(TAG, &quot;settings lookup error&quot;, e);</span><br><span class="line">        return null;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        if (cursor != null) cursor.close();</span><br><span class="line">    &#125;</span><br><span class="line">    cache.putIfAbsent(key, null);</span><br><span class="line">    return NULL_SETTING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 gitcoment -->
<div id="gitment-comment">
    <!-- Gitment 评论框 -->
<div id="container"></div>
</div>
<style>
    #gitment-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var gitment = new Gitment({
        //id: '页面 ID', // 可选。默认为 location.href
        // id: 'SettingsProvider系列2-重要的几个API方法'
        owner: 'wusp',
        repo: 'wusp.github.io',
        oauth: {
            client_id: 'cf3aa4df893d2a607397',
            client_secret: 'ea14eb0d93e926c0bb54eb827f24877a0091e129',
        },
    })
    gitment.render('container')
</script>


                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/01/27/SettingsProvider1/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/01/26/ContentProvider1/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/wusp.jpg" alt="wusp's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        podussily@163.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Archives  -->
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Android/">Android<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/categories/Kotlin/">Kotlin<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/categories/Network/">Network<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/并发编程/">并发编程<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">22</span>
            </a>
        </li>
        
            <li class="divider"></li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

    <a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
        sidebar.help
        <span class="mdl-button__ripple-container">
          <span class="mdl-ripple"></span>
        </span>
      </div>
    </a>

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

    <a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
             sidebar.about_theme
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
    </a>

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://www.github.com/wusp" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>wusp Blog
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- Gitment -->





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->


    
        <script>lsloader.load("hanabi","/js/hanabi-browser-bundle.js?Pki5+pzkluqu53g+ouMWpA==", true)</script>
    


<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
        
            HanabiBrowser.clearColors();
        
        
        HanabiBrowser.start('pre code',false);
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
